<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naptár Végleges Verzió</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        :root {
            --bg-color: #1a1a2e; --primary-container-bg: #16213e; --secondary-container-bg: #0f3460;
            --primary-accent: #e94560; --secondary-accent: #1f7a8c; --text-color: #e0e0e0;
            --text-muted: #a0a0a0; --border-color: #30304a; --today-bg: #e94560;
            --selected-bg: #1f7a8c; --event-color: #a932a8; --event-range-bg: rgba(169, 50, 168, 0.2);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding: 20px; font-size: 16px; }
        .main-container { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1800px; margin: 0 auto; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; }
        .left-panel { flex: 1; min-width: 320px; }
        .right-panel { flex: 2; min-width: 600px; }
        .widget-container, .calendar-container, .daily-panel { background: var(--primary-container-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
        h2, h3 { text-align: center; margin-bottom: 15px; }
        ul { list-style: none; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-header h2 { font-size: 1.4rem; margin: 0; }
        .calendar-header button { background: none; border: none; font-size: 1rem; cursor: pointer; color: var(--text-color); width: 35px; height: 35px; border-radius: 50%; transition: background-color 0.2s; }
        .calendar-header button:hover { background-color: var(--secondary-container-bg); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-names div { font-weight: 600; color: var(--text-muted); font-size: 0.9rem; padding-bottom: 5px; }
        .day { padding: 10px 5px; cursor: pointer; border-radius: 50%; transition: all 0.2s; aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center; font-size: 0.95rem; position: relative; }
        .day.empty { cursor: default; pointer-events: none; }
        .day:not(.empty):hover { background-color: var(--secondary-container-bg); }
        .day.today { background-color: var(--today-bg); font-weight: bold; }
        .day.selected { background-color: var(--selected-bg); }
        .day.event-start, .day.event-end { background-color: var(--event-color); color: white; }
        .day.event-range { background-color: var(--event-range-bg); border-radius: 0; }
        .day.event-start.event-range { border-radius: 50% 0 0 50%; }
        .day.event-end.event-range { border-radius: 0 50% 50% 0; }
        .day.event-start.event-end.event-range { border-radius: 50%; }
        #daily-view-container.hidden { display: none; }
        #selected-day-header { padding: 10px; background-color: var(--secondary-container-bg); border-radius: 8px; font-size: 1.2rem; }
        .daily-info-container { display: flex; gap: 20px; margin-top: 20px; }
        .daily-panel { flex: 1; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; }
        ul { overflow-y: auto; max-height: 180px; }
        .input-container { display: flex; margin-top: 15px; }
        .input-container input { flex-grow: 1; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 5px 0 0 5px; outline: none; }
        .input-container button { padding: 0 14px; border: none; background-color: var(--secondary-accent); color: #fff; border-radius: 0 5px 5px 0; cursor: pointer; }
        .deadline-input { flex-wrap: wrap; gap: 10px; }
        .deadline-input input, .deadline-input button { border-radius: 5px; width: 100%; }
        #deadline-list li, #general-todo-list li, #daily-todo-list li, #daily-events-list li { display: flex; align-items: center; padding: 10px 5px; border-bottom: 1px solid var(--border-color); }
        li span { cursor: pointer; }
        li.completed span, li.completed .event-title { text-decoration: line-through; color: var(--text-muted); }
        .deadline-countdown { font-size: 0.9rem; color: var(--primary-accent); margin-left: auto; padding-left: 10px; }
        .event-time { font-weight: 600; color: var(--secondary-accent); margin-right: 15px; }
        .event-title { flex-grow: 1; }
        .popover { display: none; position: absolute; background-color: var(--primary-container-bg); border: 1px solid var(--border-color); border-radius: 10px; width: 300px; z-index: 1000; box-shadow: 0 8px 25px rgba(0,0,0,0.4); padding: 20px; }
        .popover.visible { display: block; }
        .popover::before { content: ''; position: absolute; left: 20px; bottom: 100%; border: 8px solid transparent; border-bottom-color: var(--border-color); }
        #popover-title { font-size: 1.1rem; }
        .event-input-group { margin: 10px 0; }
        .event-input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        .event-input-group input { width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 8px; border-radius: 5px; }
        .time-inputs { display: flex; gap: 10px; }
        .all-day-container { display: flex; align-items: center; gap: 8px; margin: 12px 0; font-size: 0.9rem; }
        .all-day-container input { width: auto; }
        #time-inputs-container.hidden { display: none; }
        .popover-buttons { margin-top: 15px; display: flex; gap: 10px; }
        .popover-buttons button { padding: 8px 12px; border: none; border-radius: 5px; color: white; cursor: pointer; flex-grow: 1; }
        #save-event-btn { background-color: var(--secondary-accent); }
        #delete-event-btn { background-color: var(--primary-accent); }
        #delete-event-btn.hidden { display: none; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="left-panel">
            <div class="widget-container">
                <h2>Általános Teendők</h2>
                <ul id="general-todo-list"></ul>
                <div class="input-container">
                    <input type="text" id="general-todo-input" placeholder="Új teendő...">
                    <button id="add-general-todo-btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            <div class="widget-container">
                <h2>Határidős feladatok</h2>
                <ul id="deadline-list"></ul>
                <div class="input-container deadline-input">
                    <input type="text" id="deadline-task-input" placeholder="Feladat...">
                    <input type="date" id="deadline-date-input" title="Határidő">
                    <button id="add-deadline-task-btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="calendar-container">
                <div class="calendar-header">
                    <button id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="month-year-str"></h2>
                    <button id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid day-names">
                    <div>H</div><div>K</div><div>Sze</div><div>Cs</div><div>P</div><div>Szo</div><div>V</div>
                </div>
                <div id="calendar-days" class="calendar-grid"></div>
            </div>
            <div id="daily-view-container" class="hidden">
                <h2 id="selected-day-header"></h2>
                <div class="daily-info-container">
                     <div class="daily-panel">
                        <div class="panel-header"><h3>Napi események</h3></div>
                        <ul id="daily-events-list"></ul>
                    </div>
                    <div class="daily-panel">
                        <div class="panel-header"><h3>Napi teendők</h3></div>
                        <ul id="daily-todo-list"></ul>
                        <div class="input-container">
                            <input type="text" id="daily-todo-input" placeholder="Új napi teendő...">
                            <button id="add-daily-todo-btn"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="event-popover" class="popover">
        <h3 id="popover-title"></h3>
        <input type="hidden" id="event-id">
        <div class="event-input-group">
            <label for="event-title">Cím:</label>
            <input type="text" id="event-title" placeholder="Pl. Születésnap">
        </div>
        <div id="time-inputs-container">
            <div class="time-inputs">
                <div class="event-input-group"><label for="event-start-time">Kezdés:</label><input type="time" id="event-start-time"></div>
                <div class="event-input-group"><label for="event-end-time">Vége:</label><input type="time" id="event-end-time"></div>
            </div>
        </div>
        <div class="all-day-container">
            <input type="checkbox" id="all-day-checkbox"><label for="all-day-checkbox">Egész napos</label>
        </div>
        <div class="event-input-group">
            <label for="event-end-date">Befejezés dátuma:</label><input type="date" id="event-end-date">
        </div>
        <div class="popover-buttons">
            <button id="save-event-btn">Mentés</button><button id="delete-event-btn" class="hidden">Törlés</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. FIREBASE BEÁLLÍTÁSA
            // --------------------------------------------------------------------------
            // IDE MÁSOLD BE A FIREBASE OLDALÁRÓL KIMÁSOLT SAJÁT firebaseConfig OBJEKTUMODAT!
            const firebaseConfig = {
  apiKey: "AIzaSyCR6ukMJbiEn2b2Y4p9oSz5C7uSbCac65I",
  authDomain: "sajat-naptar-app.firebaseapp.com",
  projectId: "sajat-naptar-app",
  storageBucket: "sajat-naptar-app.firebasestorage.app",
  messagingSenderId: "437164661006",
  appId: "1:437164661006:web:8e4d55282e84fdfcf5df5f"
            };
            // --------------------------------------------------------------------------

            try {
                firebase.initializeApp(firebaseConfig);
            } catch(e) {
                console.error("Firebase inicializálási hiba! Valószínűleg rosszul másoltad be a firebaseConfig kulcsot.", e);
                alert("KRITIKUS HIBA: A Firebase inicializálása sikertelen. Ellenőrizd a kódban a firebaseConfig részt, és a böngésző konzolját (F12) a további részletekért.");
                return; // Megállítjuk a szkript futását, ha a Firebase beállítás hibás
            }
            
            const db = firebase.firestore();

            // 2. GLOBÁLIS VÁLTOZÓK ÉS ADATOK
            let currentDate = new Date();
            let selectedDate = null;
            const monthNames = ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"];
            let events = [], dailyTodos = {}, generalTodos = [], deadlineTasks = [];
            
            // 3. DOM ELEMEK
            const monthYearStrEl = document.getElementById('month-year-str');
            const calendarDaysEl = document.getElementById('calendar-days');
            const dailyViewContainer = document.getElementById('daily-view-container');
            const selectedDayHeaderEl = document.getElementById('selected-day-header');
            const dailyEventsListEl = document.getElementById('daily-events-list');
            const dailyTodoListEl = document.getElementById('daily-todo-list');
            const generalTodoListEl = document.getElementById('general-todo-list');
            const deadlineListEl = document.getElementById('deadline-list');
            const dailyTodoInputEl = document.getElementById('daily-todo-input');
            const generalTodoInputEl = document.getElementById('general-todo-input');
            const deadlineTaskInputEl = document.getElementById('deadline-task-input');
            const deadlineDateInputEl = document.getElementById('deadline-date-input');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const addDailyTodoBtn = document.getElementById('add-daily-todo-btn');
            const addGeneralTodoBtn = document.getElementById('add-general-todo-btn');
            const addDeadlineTaskBtn = document.getElementById('add-deadline-task-btn');
            const eventPopover = document.getElementById('event-popover');
            const popoverTitleEl = document.getElementById('popover-title');
            const eventIdInput = document.getElementById('event-id');
            const eventTitleInput = document.getElementById('event-title');
            const timeInputsContainer = document.getElementById('time-inputs-container');
            const eventStartTimeInput = document.getElementById('event-start-time');
            const eventEndTimeInput = document.getElementById('event-end-time');
            const allDayCheckbox = document.getElementById('all-day-checkbox');
            const eventEndDateInput = document.getElementById('event-end-date');
            const saveEventBtn = document.getElementById('save-event-btn');
            const deleteEventBtn = document.getElementById('delete-event-btn');

            // 4. FÜGGVÉNYEK
            async function loadDataFromFirebase() {
                try {
                    const doc = await db.collection("calendarData").doc("main").get();
                    if (doc.exists) {
                        const data = doc.data();
                        events = data.events || []; dailyTodos = data.dailyTodos || {};
                        generalTodos = data.generalTodos || []; deadlineTasks = data.deadlineTasks || [];
                    }
                } catch (error) { console.error("Hiba az adatok betöltése közben: ", error); }
                renderAll();
            }
            async function saveDataToFirebase() {
                try { await db.collection("calendarData").doc("main").set({ events, dailyTodos, generalTodos, deadlineTasks });
                } catch (error) { console.error("Hiba a mentés közben: ", error); }
            }
            function saveAndRenderAll() { renderAll(); saveDataToFirebase(); }
            function renderAll() { renderCalendar(); updateDailyView(); renderGeneralTodos(); renderDeadlineTasks(); }
            
            function renderCalendar() {
                calendarDaysEl.innerHTML = '';
                const year = currentDate.getFullYear(); const month = currentDate.getMonth();
                monthYearStrEl.textContent = `${year} ${monthNames[month]}`;
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayIndex = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
                for (let i = 0; i < firstDayIndex; i++) { calendarDaysEl.appendChild(document.createElement('div')).classList.add('day', 'empty'); }
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div'); dayEl.classList.add('day'); dayEl.textContent = i;
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayEl.dataset.date = dateStr;
                    if (dateStr === selectedDate) dayEl.classList.add('selected');
                    const today = new Date();
                    if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('today');
                    events.forEach(event => {
                        if (dateStr >= event.startDate && dateStr <= event.endDate) {
                            dayEl.classList.add('event-range');
                            if (dateStr === event.startDate) dayEl.classList.add('event-start');
                            if (dateStr === event.endDate) dayEl.classList.add('event-end');
                        }
                    });
                    dayEl.addEventListener('click', function() {
                        if (selectedDate === dateStr && eventPopover.classList.contains('visible')) { closePopover(); return; }
                        selectedDate = dateStr; renderAll(); openPopover(this);
                    });
                    calendarDaysEl.appendChild(dayEl);
                }
            }
            function updateDailyView() {
                if (selectedDate) {
                    dailyViewContainer.classList.remove('hidden');
                    const dateObj = new Date(selectedDate);
                    selectedDayHeaderEl.textContent = dateObj.toLocaleDateString('hu-HU', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                    dailyTodoInputEl.disabled = false; renderDailyEvents(); renderDailyTodos();
                } else { dailyViewContainer.classList.add('hidden'); }
            }
            function renderDailyEvents() {
                dailyEventsListEl.innerHTML = '';
                const dayEvents = events.filter(event => selectedDate >= event.startDate && selectedDate <= event.endDate);
                dayEvents.sort((a,b) => {
                    if (a.allDay) return -1; if (b.allDay) return 1; return a.startTime.localeCompare(b.startTime);
                });
                dayEvents.forEach(event => {
                    const li = document.createElement('li');
                    const timeText = event.allDay ? 'Egész napos' : `${event.startTime} - ${event.endTime}`;
                    li.innerHTML = `<span class="event-time">${timeText}</span><span class="event-title">${event.title}</span>`;
                    li.addEventListener('click', () => {
                        const dayEl = document.querySelector(`.day[data-date="${selectedDate}"]`);
                        if (dayEl) openPopoverForEdit(dayEl, event);
                    });
                    dailyEventsListEl.appendChild(li);
                });
            }
            function renderDailyTodos() {
                dailyTodoListEl.innerHTML = ''; (dailyTodos[selectedDate] || []).forEach((todo, index) => createTodoLi(todo, index, 'daily'));
            }
            function renderGeneralTodos() {
                generalTodoListEl.innerHTML = ''; generalTodos.forEach((todo, index) => createTodoLi(todo, index, 'general'));
            }
            function renderDeadlineTasks() {
                deadlineListEl.innerHTML = '';
                deadlineTasks.sort((a,b) => new Date(a.deadline) - new Date(b.deadline));
                deadlineTasks.forEach((task) => {
                    const li = document.createElement('li'); if (task.completed) li.classList.add('completed');
                    const today = new Date(); today.setHours(0,0,0,0); const deadline = new Date(task.deadline);
                    const diffDays = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                    let countdownText = (diffDays < 0) ? `Lejárt (${Math.abs(diffDays)} napja)` : (diffDays === 0) ? 'Ma!' : `${diffDays} nap van hátra`;
                    li.innerHTML = `<span>${task.text}</span><span class="deadline-countdown">${countdownText}</span>`;
                    li.querySelector('span').addEventListener('click', () => { task.completed = !task.completed; saveAndRenderAll(); });
                    deadlineListEl.appendChild(li);
                });
            }
            function createTodoLi(todo, index, type) {
                const parentEl = type === 'daily' ? dailyTodoListEl : generalTodoListEl;
                const li = document.createElement('li'); if (todo.completed) li.classList.add('completed');
                li.innerHTML = `<span>${todo.text}</span>`;
                li.querySelector('span').addEventListener('click', () => {
                    if (type === 'daily') dailyTodos[selectedDate][index].completed = !dailyTodos[selectedDate][index].completed;
                    else generalTodos[index].completed = !generalTodos[index].completed;
                    saveAndRenderAll();
                });
                parentEl.appendChild(li);
            }
            function openPopover(dayElement) {
                const dateObj = new Date(selectedDate);
                popoverTitleEl.textContent = `Új esemény - ${dateObj.toLocaleDateString('hu-HU', {month: 'long', day: 'numeric'})}`;
                eventIdInput.value = ''; eventTitleInput.value = ''; allDayCheckbox.checked = false; toggleTimeInputs();
                eventStartTimeInput.value = '12:00'; eventEndTimeInput.value = '13:00'; eventEndDateInput.value = selectedDate;
                deleteEventBtn.classList.add('hidden');
                const dayRect = dayElement.getBoundingClientRect();
                eventPopover.style.left = `${dayRect.left + window.scrollX}px`;
                eventPopover.style.top = `${dayRect.bottom + window.scrollY + 10}px`;
                eventPopover.classList.add('visible');
            }
            function openPopoverForEdit(dayElement, event) {
                openPopover(dayElement); popoverTitleEl.textContent = 'Esemény szerkesztése';
                eventIdInput.value = event.id; eventTitleInput.value = event.title; allDayCheckbox.checked = event.allDay;
                toggleTimeInputs(); eventStartTimeInput.value = event.startTime; eventEndTimeInput.value = event.endTime;
                eventEndDateInput.value = event.endDate; deleteEventBtn.classList.remove('hidden');
            }
            function closePopover() { eventPopover.classList.remove('visible'); }
            function toggleTimeInputs() { timeInputsContainer.classList.toggle('hidden', allDayCheckbox.checked); }
            function saveEvent() {
                const id = eventIdInput.value || Date.now().toString(); const startDate = selectedDate;
                const endDate = eventEndDateInput.value || startDate;
                if (endDate < startDate) { alert('A befejezés dátuma nem lehet korábbi a kezdésnél!'); return; }
                const eventData = { id, title: eventTitleInput.value.trim(), allDay: allDayCheckbox.checked, startTime: allDayCheckbox.checked ? '' : eventStartTimeInput.value, endTime: allDayCheckbox.checked ? '' : eventEndTimeInput.value, startDate, endDate };
                if (!eventData.title) { alert("A cím megadása kötelező!"); return; }
                events = events.filter(e => e.id !== id); events.push(eventData);
                closePopover(); saveAndRenderAll();
            }
            function deleteEvent(eventId) {
                if (confirm('Biztosan törlöd ezt az eseményt?')) {
                    events = events.filter(e => e.id !== eventId);
                    closePopover(); saveAndRenderAll();
                }
            }
            // 5. ESEMÉNYKEZELŐK
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAll(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderAll(); });
            allDayCheckbox.addEventListener('change', toggleTimeInputs);
            saveEventBtn.addEventListener('click', saveEvent);
            deleteEventBtn.addEventListener('click', () => deleteEvent(eventIdInput.value));
            document.addEventListener('click', (e) => {
                if (!eventPopover.contains(e.target) && !e.target.closest('.day') && !e.target.closest('#daily-events-list li')) closePopover();
            });
            addDailyTodoBtn.addEventListener('click', () => {
                const text = dailyTodoInputEl.value.trim();
                if (text && selectedDate) {
                    if (!dailyTodos[selectedDate]) dailyTodos[selectedDate] = [];
                    dailyTodos[selectedDate].push({ text, completed: false });
                    dailyTodoInputEl.value = ''; saveAndRenderAll();
                }
            });
            addGeneralTodoBtn.addEventListener('click', () => {
                const text = generalTodoInputEl.value.trim();
                if (text) { generalTodos.push({ text, completed: false }); generalTodoInputEl.value = ''; saveAndRenderAll(); }
            });
            addDeadlineTaskBtn.addEventListener('click', () => {
                const text = deadlineTaskInputEl.value.trim(); const deadline = deadlineDateInputEl.value;
                if (text && deadline) {
                    deadlineTasks.push({ text, deadline, completed: false });
                    deadlineTaskInputEl.value = ''; deadlineDateInputEl.value = ''; saveAndRenderAll();
                } else { alert('Add meg a feladatot és a határidőt is!'); }
            });
            // 6. INDÍTÁS
            loadDataFromFirebase();
        });
    </script>
</body>
</html>